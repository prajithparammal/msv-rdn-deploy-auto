---
  - name: Installing postgres DB
    yum:
      name: "{{ item }}"
      state: present
    with_items:
      - postgresql-server
      - postgresql-contrib

  - name: Check if PostgreSQL database is initialized.
    stat:
      path: "{{ postgresql_data_dir }}/PG_VERSION"
    register: pgdata_dir_version

  - name: Ensure PostgreSQL database is initialized.
    command: postgresql-setup initdb
    when: not pgdata_dir_version.stat.exists

  - name: Setting up {{ postgresql_user }} credentials
    user: name={{ postgresql_user }} update_password=always password={{ postgresql_password | password_hash('sha512')}}

  - name: Adding firewalld rule for postgres
    firewalld:
      port: 5432/tcp
      permanent: yes
      state: enabled

  - name: Starting and enabling postgresql service
    service:
      name: postgresql
      state: started
      enabled: yes
